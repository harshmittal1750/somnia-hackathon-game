<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wallet Debug Test</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #1a1a1a;
        color: #fff;
      }
      .log {
        margin: 5px 0;
        padding: 5px;
        background: #333;
        border-radius: 3px;
      }
      .success {
        background: #2d5016;
      }
      .error {
        background: #501616;
      }
      .info {
        background: #162050;
      }
      button {
        margin: 5px;
        padding: 10px;
        background: #0066ff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ”§ Wallet Connection Debug Test</h1>
    <div id="logs"></div>

    <h2>Manual Tests</h2>
    <button onclick="testWagmiConfig()">Test Wagmi Config</button>
    <button onclick="testWagmiManager()">Test WagmiManager</button>
    <button onclick="testHybridManager()">Test HybridManager</button>
    <button onclick="clearLogs()">Clear Logs</button>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>

    <!-- Wagmi Core for fallback wallet connection -->
    <script type="module">
      import { createClient } from "https://esm.sh/viem@2.x";
      import { createConfig } from "https://esm.sh/@wagmi/core@2.x";
      import {
        injected,
        metaMask,
        walletConnect,
        coinbaseWallet,
      } from "https://esm.sh/@wagmi/connectors@5.x";
      import { mainnet, sepolia } from "https://esm.sh/viem@2.x/chains";

      // Custom Somnia chain configuration for Wagmi
      const somniaTestnet = {
        id: 50312,
        name: "Somnia Testnet",
        nativeCurrency: {
          decimals: 18,
          name: "STT",
          symbol: "STT",
        },
        rpcUrls: {
          default: {
            http: ["https://dream-rpc.somnia.network"],
          },
          public: {
            http: ["https://dream-rpc.somnia.network"],
          },
        },
        blockExplorers: {
          default: {
            name: "Shannon Explorer",
            url: "https://shannon-explorer.somnia.network",
          },
        },
        testnet: true,
      };

      // Create Wagmi config
      const wagmiConfig = createConfig({
        chains: [somniaTestnet, mainnet, sepolia],
        connectors: [
          injected(),
          metaMask(),
          walletConnect({
            projectId: "27022fe9a4b6f8e10b631d90a341a3c0",
            metadata: {
              name: "Somnia Space Defender",
              description: "Web3 Space Defense Game",
              url: "https://spacedefender.xyz",
              icons: ["https://spacedefender.xyz/favicon.svg"],
            },
          }),
          coinbaseWallet({
            appName: "Somnia Space Defender",
            appLogoUrl: "https://spacedefender.xyz/favicon.svg",
          }),
        ],
      });

      // Make Wagmi config available globally
      window.wagmiConfig = wagmiConfig;
      window.somniaChain = somniaTestnet;

      addLog("ðŸŽ¯ Wagmi Core initialized", "success");
    </script>

    <script src="js/config.js"></script>
    <script src="js/services/apiService.js"></script>
    <script src="js/wagmiManager.js"></script>
    <script src="js/hybridWeb3Manager.js"></script>

    <script>
      // Logging system
      function addLog(message, type = "info") {
        const logs = document.getElementById("logs");
        const logDiv = document.createElement("div");
        logDiv.className = `log ${type}`;
        logDiv.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
        logs.appendChild(logDiv);
        console.log(message);
      }

      function clearLogs() {
        document.getElementById("logs").innerHTML = "";
      }

      // Test functions
      function testWagmiConfig() {
        addLog("Testing Wagmi Config...", "info");
        try {
          if (window.wagmiConfig) {
            addLog("âœ… Wagmi Config available", "success");
            addLog(`Chains: ${window.wagmiConfig.chains?.length || 0}`, "info");
            addLog(
              `Connectors: ${window.wagmiConfig.connectors?.length || 0}`,
              "info"
            );
          } else {
            addLog("âŒ Wagmi Config not found", "error");
          }
        } catch (error) {
          addLog(`âŒ Wagmi Config test failed: ${error.message}`, "error");
        }
      }

      function testWagmiManager() {
        addLog("Testing WagmiManager...", "info");
        try {
          if (typeof WagmiManager !== "undefined") {
            addLog("âœ… WagmiManager class available globally", "success");
          } else if (typeof window.WagmiManager !== "undefined") {
            addLog("âœ… WagmiManager class available on window", "success");
          } else {
            addLog("âŒ WagmiManager class not found", "error");
            return;
          }

          const manager = new (window.WagmiManager || WagmiManager)();
          addLog("âœ… WagmiManager instance created successfully", "success");

          // Test some properties
          addLog(`Config loaded: ${!!manager.config}`, "info");
          addLog(`Is connected: ${manager.isConnected}`, "info");
        } catch (error) {
          addLog(`âŒ WagmiManager test failed: ${error.message}`, "error");
        }
      }

      function testHybridManager() {
        addLog("Testing HybridWeb3Manager...", "info");
        try {
          if (typeof hybridWeb3Manager !== "undefined") {
            addLog("âœ… HybridWeb3Manager instance available", "success");

            const info = hybridWeb3Manager.getConnectionInfo();
            addLog(`Connection info: ${JSON.stringify(info)}`, "info");

            addLog(
              `Primary provider available: ${hybridWeb3Manager.primaryProvider?.available}`,
              "info"
            );
            addLog(
              `Fallback provider available: ${hybridWeb3Manager.fallbackProvider?.available}`,
              "info"
            );
          } else {
            addLog("âŒ HybridWeb3Manager instance not found", "error");
          }
        } catch (error) {
          addLog(`âŒ HybridWeb3Manager test failed: ${error.message}`, "error");
        }
      }

      // Auto-run tests on load
      setTimeout(() => {
        addLog("ðŸš€ Starting automatic tests...", "info");
        testWagmiConfig();
        setTimeout(() => testWagmiManager(), 500);
        setTimeout(() => testHybridManager(), 1000);
      }, 1000);
    </script>
  </body>
</html>

